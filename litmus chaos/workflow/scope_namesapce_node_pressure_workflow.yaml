kind: CronWorkflow
apiVersion: argoproj.io/v1alpha1
metadata:
  name: custom-chaos-workflow-1633531334
  namespace: hipster-shop
  creationTimestamp: null
  annotation:
    sidecar.istio.io/inject: "false"
  labels:
    cluster_id: 8d396188-c602-45ff-b305-e4bc07135359
    subject: custom-chaos-workflow_hipster-shop
    workflow_id: 6a950ac3-491e-45c8-bbe4-47905f202dc3
    workflows.argoproj.io/controller-instanceid: 8d396188-c602-45ff-b305-e4bc07135359
spec:
  workflowSpec:
    templates:
      - name: custom-chaos
        arguments: {}
        inputs: {}
        outputs: {}
        metadata: {}
        steps:
          - - name: install-chaos-experiments
              template: install-chaos-experiments
              arguments: {}
          - - name: node-memory-hog
              template: node-memory-hog
              arguments: {}
            - name: node-cpu-hog
              template: node-cpu-hog
              arguments: {}
          - - name: revert-chaos
              template: revert-chaos
              arguments: {}
      - name: install-chaos-experiments
        arguments: {}
        inputs:
          artifacts:
            - name: node-memory-hog
              path: /tmp/node-memory-hog.yaml
              raw:
                data: |
                  apiVersion: litmuschaos.io/v1alpha1
                  description:
                    message: |
                      Give a memory hog on a node belonging to a deployment
                  kind: ChaosExperiment
                  metadata:
                    name: node-memory-hog
                    labels:
                      name: node-memory-hog
                      app.kubernetes.io/part-of: litmus
                      app.kubernetes.io/component: chaosexperiment
                      app.kubernetes.io/version: 2.0.0
                  spec:
                    definition:
                      scope: Cluster
                      permissions:
                        - apiGroups:
                            - ""
                            - batch
                            - litmuschaos.io
                          resources:
                            - jobs
                            - pods
                            - pods/log
                            - pods/exec
                            - events
                            - chaosengines
                            - replicationcontrollers
                            - pods/eviction
                            - chaosexperiments
                            - chaosresults
                          verbs:
                            - create
                            - list
                            - get
                            - patch
                            - update
                            - delete
                            - deletecollection
                        - apiGroups:
                            - ""
                          resources:
                            - nodes
                          verbs:
                            - get
                            - list
                      image: litmuschaos/go-runner:2.0.0
                      imagePullPolicy: Always
                      args:
                        - -c
                        - ./experiments -name node-memory-hog
                      command:
                        - /bin/bash
                      env:
                        - name: TOTAL_CHAOS_DURATION
                          value: "120"
                        - name: MEMORY_CONSUMPTION_PERCENTAGE
                          value: ""
                        - name: MEMORY_CONSUMPTION_MEBIBYTES
                          value: ""
                        - name: NUMBER_OF_WORKERS
                          value: "1"
                        - name: NODE_LABEL
                          value: "node-type=worker"
                        - name: RAMP_TIME
                          value: ""
                        - name: LIB
                          value: litmus
                        - name: LIB_IMAGE
                          value: litmuschaos/go-runner:2.0.0
                        - name: NODES_AFFECTED_PERC
                          value: "40"
                        - name: SEQUENCE
                          value: parallel
                      labels:
                        name: node-memory-hog
                        app.kubernetes.io/part-of: litmus
                        app.kubernetes.io/component: experiment-job
                        app.kubernetes.io/version: 2.0.0
            - name: node-cpu-hog
              path: /tmp/node-cpu-hog.yaml
              raw:
                data: |
                  apiVersion: litmuschaos.io/v1alpha1
                  description:
                    message: |
                      Give a cpu spike on a node belonging to a deployment
                  kind: ChaosExperiment
                  metadata:
                    name: node-cpu-hog
                    labels:
                      name: node-cpu-hog
                      app.kubernetes.io/part-of: litmus
                      app.kubernetes.io/component: chaosexperiment
                      app.kubernetes.io/version: 2.0.0
                  spec:
                    definition:
                      scope: Cluster
                      permissions:
                        - apiGroups:
                            - ""
                            - batch
                            - litmuschaos.io
                            - apps
                          resources:
                            - jobs
                            - pods
                            - pods/eviction
                            - deployments
                            - pods/log
                            - pods/exec
                            - events
                            - chaosengines
                            - chaosexperiments
                            - chaosresults
                          verbs:
                            - create
                            - list
                            - get
                            - patch
                            - update
                            - delete
                            - deletecollection
                        - apiGroups:
                            - ""
                          resources:
                            - nodes
                          verbs:
                            - get
                            - list
                      image: litmuschaos/go-runner:2.0.0
                      imagePullPolicy: Always
                      args:
                        - -c
                        - ./experiments -name node-cpu-hog
                      command:
                        - /bin/bash
                      env:
                        - name: TOTAL_CHAOS_DURATION
                          value: "60"
                        - name: RAMP_TIME
                          value: ""
                        - name: NODE_CPU_CORE
                          value: "1"
                        - name: NODE_LABEL
                          value: "node-type=worker"
                        - name: LIB
                          value: litmus
                        - name: LIB_IMAGE
                          value: litmuschaos/go-runner:2.0.0
                        - name: NODES_AFFECTED_PERC
                          value: "40"
                        - name: SEQUENCE
                          value: parallel
                      labels:
                        name: node-cpu-hog
                        app.kubernetes.io/part-of: litmus
                        app.kubernetes.io/component: experiment-job
                        app.kubernetes.io/version: 2.0.0
        outputs: {}
        metadata: {}
        container:
          name: ""
          image: litmuschaos/k8s:latest
          command:
            - sh
            - -c
          args:
            -   kubectl apply -f
              /tmp/node-memory-hog.yaml -n
              {{workflow.parameters.adminModeNamespace}} | kubectl apply -f /tmp/node-cpu-hog.yaml -n
              {{workflow.parameters.adminModeNamespace}}| sleep 30
          resources: {}
        nodeSelector:
          node-type: chaos
      - name: node-memory-hog
        arguments: {}
        inputs:
          artifacts:
            - name: node-memory-hog
              path: /tmp/chaosengine-node-memory-hog.yaml
              raw:
                data: >
                  apiVersion: litmuschaos.io/v1alpha1

                  kind: ChaosEngine

                  metadata:
                    namespace: "{{workflow.parameters.adminModeNamespace}}"
                    generateName: node-memory-hog
                    labels:
                      instance_id: 6aab9307-b114-40ec-9f54-e55d57b11e9e
                      context: node-memory-hog_hipster-shop
                      workflow_name: custom-chaos-workflow-1633531334
                  spec:
                    components:
                      runner:
                        nodeSelector:
                          node-type: chaos
                        runnerAnnotations:
                          sidecar.istio.io/inject: "false"
                    jobCleanUpPolicy: retain
                    engineState: active
                    auxiliaryAppInfo: ""
                    chaosServiceAccount: litmus-admin
                    experiments:
                      - name: node-memory-hog
                        spec:
                          components:
                            nodeSelector:
                              node-type: chaos
                            experimentAnnotations:
                              sidecar.istio.io/inject: "false"
                            env:
                              - name: TOTAL_CHAOS_DURATION
                                value: "600"
                              - name: MEMORY_CONSUMPTION_PERCENTAGE
                                value: "50"
                              - name: TARGET_NODES
                                value: 'gke-onlineboutique-default-pool-112e98a2-ghbb,gke-onlineboutique-default-pool-112e98a2-h3cs'
                          probe: []
                    annotationCheck: "false"
        outputs: {}
        metadata:
          labels:
            weight: "10"
        container:
          name: ""
          image: litmuschaos/litmus-checker:latest
          args:
            - -file=/tmp/chaosengine-node-memory-hog.yaml
            - -saveName=/tmp/engine-name
          resources: {}
      - name: node-cpu-hog
        arguments: { }
        inputs:
          artifacts:
            - name: node-cpu-hog
              path: /tmp/chaosengine-node-cpu-hog.yaml
              raw:
                data: >
                  apiVersion: litmuschaos.io/v1alpha1

                  kind: ChaosEngine

                  metadata:
                    namespace: "{{workflow.parameters.adminModeNamespace}}"
                    generateName: node-cpu-hog
                    labels:
                      instance_id: ec583c70-9c6f-461d-a3b7-ba6d6d17cc57
                      context: node-cpu-hog_hipster-shop
                      workflow_name: custom-chaos-workflow-1633531334
                  spec:
                    components:
                      runner:
                        nodeSelector:
                          node-type: chaos
                        runnerAnnotations:
                          sidecar.istio.io/inject: "false"
                    jobCleanUpPolicy: retain
                    engineState: active
                    auxiliaryAppInfo: ""
                    chaosServiceAccount: litmus-admin
                    experiments:
                      - name: node-cpu-hog
                        spec:
                          components:
                            nodeSelector:
                              node-type: chaos
                            experimentAnnotations:
                              sidecar.istio.io/inject: "false"
                            env:
                              - name: TOTAL_CHAOS_DURATION
                                value: "600"
                              - name: NODE_CPU_CORE
                                value: "1"
                              - name: TARGET_NODES
                                value: 'gke-onlineboutique-default-pool-112e98a2-ghbb,gke-onlineboutique-default-pool-112e98a2-h3cs'
                          probe: []
                    annotationCheck: "false"
        outputs: { }
        metadata:
          labels:
            weight: "10"
        container:
          name: ""
          image: litmuschaos/litmus-checker:latest
          args:
            - -file=/tmp/chaosengine-node-cpu-hog.yaml
            - -saveName=/tmp/engine-name
          resources: { }
      - name: revert-chaos
        arguments: {}
        inputs: {}
        outputs: {}
        metadata: {}
        container:
          name: ""
          image: litmuschaos/k8s:latest
          command:
            - sh
            - -c
          args:
            - "kubectl delete chaosengine -l 'instance_id in
              (ec583c70-9c6f-461d-a3b7-ba6d6d17cc57,
              6aab9307-b114-40ec-9f54-e55d57b11e9e, )' -n
              {{workflow.parameters.adminModeNamespace}} "
          resources: {}
    entrypoint: custom-chaos
    arguments:
      parameters:
        - name: adminModeNamespace
          value: hipster-shop
    serviceAccountName: argo-chaos
    podGC:
      strategy: OnWorkflowCompletion
    securityContext:
      runAsUser: 1000
      runAsNonRoot: true
  schedule: 15 0-23 * * *
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 0
  timezone: Europe/Paris
  workflowMetadata:
    creationTimestamp: null
    labels:
      cluster_id: 8d396188-c602-45ff-b305-e4bc07135359
      workflow_id: 6a950ac3-491e-45c8-bbe4-47905f202dc3
      workflows.argoproj.io/controller-instanceid: 8d396188-c602-45ff-b305-e4bc07135359
status: {}
